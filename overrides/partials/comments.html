{% if page.meta.comments %}
  <h2 id="__comments">{{ lang.t("meta.comments") }}</h2>
  <div class="comments">
    <script src="https://giscus.app/client.js"
        data-repo="FreemanKevin/Meowtopia"
        data-repo-id="R_kgDONiJ7mQ"
        data-category="General"
        data-category-id="DIC_kwDONiJ7mc4ClzxZ"
        data-mapping="pathname"
        data-strict="0"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-input-position="top"
        data-theme="preferred_color_scheme"
        data-lang="zh-CN"
        data-loading="lazy"
        crossorigin="anonymous"
        async>
    </script>
  </div>
{% endif %}

<script>
  // 在页面加载完成后初始化
  document.addEventListener('DOMContentLoaded', function() {
    // 获取当前主题
    const getTheme = () => document.body.getAttribute('data-md-color-scheme') === 'slate' ? 'dark' : 'light';
    
    // 更新 Giscus 主题
    const updateGiscusTheme = () => {
      const theme = getTheme();
      const iframe = document.querySelector('iframe.giscus-frame');
      if (iframe) {
        iframe.contentWindow.postMessage(
          { giscus: { setConfig: { theme } } },
          'https://giscus.app'
        );
      }
    };

    // 监听主题切换
    const observer = new MutationObserver(() => {
      updateGiscusTheme();
    });

    // 开始监听
    observer.observe(document.body, {
      attributes: true,
      attributeFilter: ['data-md-color-scheme']
    });

    // 监听 iframe 加载
    const commentsContainer = document.querySelector('.comments');
    if (commentsContainer) {
      const iframeObserver = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
          mutation.addedNodes.forEach((node) => {
            if (node.tagName === 'IFRAME' && node.classList.contains('giscus-frame')) {
              updateGiscusTheme();
            }
          });
        });
      });

      iframeObserver.observe(commentsContainer, {
        childList: true,
        subtree: true
      });
    }
  });
</script>